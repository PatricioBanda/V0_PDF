{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Patricio%20Vargas/Downloads/program-fix%20%2810%29/app/api/rh/join/base/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { PDFDocument } from 'pdf-lib'\n\ninterface FileData {\n  name: string\n  data: string // base64\n  type: string\n}\n\ninterface JoinRequest {\n  year: string\n  months: string[]\n  files: FileData[]\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    console.log('[v0] API: Join request received')\n    const body: JoinRequest = await request.json()\n    const { year, months, files } = body\n\n    if (!year || !months || months.length === 0) {\n      return NextResponse.json(\n        { error: 'Year and months are required' },\n        { status: 400 }\n      )\n    }\n\n    console.log('[v0] API: Processing', files?.length || 0, 'files')\n\n    const mergedPdf = await PDFDocument.create()\n\n    if (files && files.length > 0) {\n      for (let i = 0; i < files.length; i++) {\n        const file = files[i]\n        console.log(`[v0] API: Processing file ${i + 1}/${files.length}:`, file.name)\n\n        try {\n          // Convert base64 back to binary\n          const binaryString = atob(file.data)\n          const bytes = new Uint8Array(binaryString.length)\n          for (let j = 0; j < binaryString.length; j++) {\n            bytes[j] = binaryString.charCodeAt(j)\n          }\n\n          const ext = file.name.split('.').pop()?.toLowerCase()\n\n          if (ext === 'pdf') {\n            console.log('[v0] API: Loading PDF:', file.name)\n            const existingPdf = await PDFDocument.load(bytes)\n            const pages = await mergedPdf.copyPages(existingPdf, existingPdf.getPageIndices())\n            \n            // Add all pages preserving their original orientation\n            for (const page of pages) {\n              mergedPdf.addPage(page)\n            }\n            console.log('[v0] API: Added', pages.length, 'pages from', file.name)\n          } else if (ext === 'jpg' || ext === 'jpeg' || ext === 'png') {\n            console.log('[v0] API: Converting image to PDF:', file.name)\n            \n            let image\n            if (ext === 'jpg' || ext === 'jpeg') {\n              image = await mergedPdf.embedJpg(bytes)\n            } else {\n              image = await mergedPdf.embedPng(bytes)\n            }\n\n            // Get image dimensions\n            const imgWidth = image.width\n            const imgHeight = image.height\n            \n            // Determine page orientation based on image dimensions\n            const isLandscape = imgWidth > imgHeight\n            \n            // Standard A4 dimensions in points (72 points per inch)\n            const A4_WIDTH = 595.28\n            const A4_HEIGHT = 841.89\n            \n            let pageWidth, pageHeight\n            if (isLandscape) {\n              pageWidth = A4_HEIGHT\n              pageHeight = A4_WIDTH\n            } else {\n              pageWidth = A4_WIDTH\n              pageHeight = A4_HEIGHT\n            }\n\n            // Create page with correct orientation\n            const page = mergedPdf.addPage([pageWidth, pageHeight])\n            \n            // Calculate scaling to fit image on page while maintaining aspect ratio\n            const scaleX = pageWidth / imgWidth\n            const scaleY = pageHeight / imgHeight\n            const scale = Math.min(scaleX, scaleY) * 0.95 // 95% to add small margin\n            \n            const scaledWidth = imgWidth * scale\n            const scaledHeight = imgHeight * scale\n            \n            // Center the image on the page\n            const x = (pageWidth - scaledWidth) / 2\n            const y = (pageHeight - scaledHeight) / 2\n            \n            page.drawImage(image, {\n              x,\n              y,\n              width: scaledWidth,\n              height: scaledHeight\n            })\n            \n            console.log('[v0] API: Image converted to PDF page with', isLandscape ? 'landscape' : 'portrait', 'orientation')\n          }\n        } catch (error) {\n          console.error('[v0] API: Error processing file:', file.name, error)\n          throw new Error(`Erro ao processar ${file.name}: ${(error as Error).message}`)\n        }\n      }\n    }\n\n    console.log('[v0] API: Finalizing merged PDF with', mergedPdf.getPageCount(), 'pages')\n\n    // Serialize the PDF\n    const pdfBytes = await mergedPdf.save()\n\n    const filename = months.length === 1 \n      ? `base_${months[0]}.pdf`\n      : `base_${months[0]}_to_${months[months.length - 1]}.pdf`\n\n    console.log('[v0] API: Sending PDF:', filename)\n\n    return new NextResponse(pdfBytes, {\n      status: 200,\n      headers: {\n        'Content-Type': 'application/pdf',\n        'Content-Disposition': `attachment; filename=\"${filename}\"`\n      }\n    })\n  } catch (error) {\n    console.error('[v0] API: Error joining PDFs:', error)\n    return NextResponse.json(\n      { error: `Failed to join PDFs: ${(error as Error).message}` },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}